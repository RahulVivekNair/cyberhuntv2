<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicons -->
    <link rel="icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/site.webmanifest">

    <title>Cyberhunt</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="/static/js/html5-qrcode.min.js"></script>
</head>

<body>
    <header>
        <nav>
            <h1>Cyberhunt</h1>
            <div>
                <a href="/leaderboard">Leaderboard</a>
                <button id="logout">Logout</button>
            </div>
        </nav>
    </header>
    <main>
        <div>
            <div id="groupInfo">
                <div>{{.Group.Name}}</div>
                <div>{{.Group.Pathway}}</div>
                <div id="clueProgress">{{if .Group.Completed}}COMPLETE{{else}}Clue:
                    {{.Group.CurrentClueIdx}}/{{.TotalClues}}{{end}}</div>
            </div>
            <div id="clue">{{.Clue}}</div>
        </div>
        <div>
            <h2>Scan QR Code</h2>
            <div id="reader"></div>
            <button id="toggleCamera">Turn Camera On</button>
        </div>"
    </main>
    <footer>
        <p>© 2025 Cyberhunt</p>
    </footer>
    <script>
        qrScanner = new Html5Qrcode("reader");
        const toggleBtn = document.getElementById("toggleCamera");
        let cameraOn = false;

        async function startCamera() {
            try {
                await qrScanner.start(
                    { facingMode: "environment" },
                    { width: 250, height: 250 },
                    validateQRCode,
                    (errMsg) => {
                        // ignore frequent scan errors
                    }
                );
                console.log("Camera Started");
                cameraOn = true
                toggleBtn.textContent = "Turn Camera Off";
            } catch (err) {
                console.error("Failed to start camera: ", err)
            }
        }

        async function stopCamera() {
            try {
                await qrScanner.stop();
                await qrScanner.clear();
                cameraOn = false;
                console.log("Camera stopped");
                toggleBtn.textContent = "Turn Camera On";
            } catch (err) {
                console.error("Failed to stop camera:", err);
            }
        }

        toggleBtn.addEventListener("click", async () => {
            if (cameraOn) {
                await stopCamera();
            } else {
                await startCamera();
            }
        });

        async function validateQRCode(decodedText) {
            try {
                await qrScanner.pause();
                const res = await fetch("/api/scan", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ code: decodedText }),
                });

                const data = await res.json();

                if (data.success) {
                    console.log("✅", data.message);

                    // Refresh the clue progress + clue text
                    await refreshGroupPartial();
                } else {
                    console.log("❌", data.message || "Incorrect code");
                }
            } catch (err) {
                console.error("Failed to validate scan:", err);
            } finally {
                setTimeout(async () => {
                    try {
                        await qrScanner.resume();
                    } catch (err) {
                        console.warn("Resume failed:", err);
                    }
                }, 500);
            }
        }

        async function refreshGroupPartial() {
            try {
                const res = await fetch("/api/game-partial");
                const html = await res.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");

                document.getElementById("clueProgress").innerHTML =
                    doc.querySelector("#clueProgress").innerHTML;
                document.getElementById("clue").innerHTML =
                    doc.querySelector("#clue").innerHTML;
            } catch (err) {
                console.error("Failed to refresh clue:", err);
            }
        }

    </script>
</body>

</html>