<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyberhunt</title>

    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <!-- Favicons -->
    <link rel="icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/site.webmanifest">

    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- <script src="/static/js/html5-qrcode.min.js"></script> -->
    <script src="/static/js/qr-scanner.min.js"></script>
</head>

<body class="min-h-screen bg-base-200 font-sans text-base">
    <div id="alertContainer" class="fixed bottom-4 left-1/2 -translate-x-1/2 space-y-2 w-80 z-50"></div>
    <nav class="navbar bg-base-100 shadow-lg sticky top-0 z-40 px-4 sm:px-6 py-2 sm:py-3">
        <div class="flex-1">
            <h1 class="text-xl sm:text-2xl font-bold text-primary">Cyberhunt</h1>
        </div>
        <div class="flex-none gap-2">
            <a href="/leaderboard" class="btn btn-outline btn-primary btn-sm">Leaderboard</a>
            <button id="logout" class="btn btn-error btn-sm" onclick="logoutModal.showModal()">Logout</button>
        </div>
    </nav>

    <main class="container mx-auto p-4 max-w-2xl space-y-4">
        <!-- Group Info Card -->
        <div class="card bg-base-100 shadow-xl rounded-2xl">
            <div class="card-body">

                <div id="groupInfo" class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                    <div class="badge badge-outline badge-lg w-full justify-center">{{.Group.Name}}</div>
                    <div class="badge badge-outline badge-lg w-full justify-center">{{.Group.Pathway}}</div>
                    <div id="clueProgress" class="badge badge-outline badge-lg w-full justify-center">
                        {{if .Group.Completed}}COMPLETE{{else}}Clue: {{.Group.CurrentClueIdx}}/{{.TotalClues}}{{end}}
                    </div>
                </div>
            </div>
        </div>

        <!-- Clue Card -->
        <div class="card bg-base-100 shadow-xl rounded-2xl">
            <div class="card-body">

                <div id="clue" class="p-4 bg-base-200 rounded-lg  text-center text-lg font-medium">
                    {{.Clue}}
                </div>
            </div>
        </div>

        <!-- QR Scanner Card -->
        <div class="card bg-base-100 shadow-xl rounded-2xl">
            <div class="card-body items-center">
                <h2 class="card-title">Scan QR Code</h2>
                <div id="reader"
                    class="hidden w-full max-w-sm mx-auto rounded-lg aspect-square bg-base-200 overflow-hidden">
                    <video id="qr-video" class="w-full h-full object-cover"></video>
                </div>
                <button id="toggleCamera" class="btn btn-secondary  mt-2">Turn Camera On</button>
                <p class="text-xs text-gray-500 text-center mt-2">Point your camera at a QR code to scan</p>
            </div>
        </div>
    </main>

    <dialog id="logoutModal" class="modal">
        <div class="modal-box">
            <h3 class="text-lg font-bold">Confirm Logout</h3>
            <p class="py-2">Are you sure you want to log out?</p>
            <div class="modal-action">
                <!-- Cancel closes the modal -->
                <form method="dialog">
                    <button class="btn">Cancel</button>
                </form>
                <!-- Logout triggers logout -->
                <button id="confirmLogout" class="btn btn-error">Logout</button>
            </div>
        </div>

        <!-- Clicking outside closes the modal -->
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
    <script>
        let scanningEnabled = true;
        const videoElem = document.getElementById("qr-video")
        const qrScanner = new QrScanner(
            videoElem,
            result => {
                if (!scanningEnabled) return;   // ignore scans if locked
                scanningEnabled = false;        // lock immediately

                validateQRCode(result.data).finally(() => {
                    // unlock after a short cooldown so alerts don’t pile
                    setTimeout(() => { scanningEnabled = true; }, 2100);
                });
            },
            {
                preferredCamera: 'environment',
                maxScansPerSecond: 5,
                returnDetailedScanResult: false
            }
        );
        const toggleBtn = document.getElementById("toggleCamera");
        let cameraOn = false;

        async function startCamera() {
            try {
                document.getElementById("reader").classList.remove("hidden");
                // QrScanner uses its own start() signature — no facingMode / fps here
                await qrScanner.start();
                const cameras = await QrScanner.listCameras(true);
                const backCam = cameras.find(cam => /back|rear|environment/i.test(cam.label));
                if (backCam) {
                    await qrScanner.setCamera(backCam.id);
                }

                console.log("Camera Started");
                cameraOn = true;
                toggleBtn.textContent = "Turn Camera Off";
            } catch (err) {
                console.error("Failed to start camera: ", err);
            }
        }

        async function stopCamera() {
            try {
                await qrScanner.stop();
                // don't call qrScanner.clear() — that was Html5Qrcode API
                document.getElementById("reader").classList.add("hidden");
                cameraOn = false;
                console.log("Camera stopped");
                toggleBtn.textContent = "Turn Camera On";
            } catch (err) {
                console.error("Failed to stop camera:", err);
            }
        }

        toggleBtn.addEventListener("click", async () => {
            if (cameraOn) {
                await stopCamera();
            } else {
                await startCamera();
            }
        });

        async function validateQRCode(decodedText) {
            try {
                const res = await fetch("/api/scan", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ code: decodedText }),
                });

                const data = await res.json();

                if (data.success) {
                    console.log("✅ Correct! Moving to next clue...", data.message);
                    showAlert(data.message || "Correct code!", "success");
                    // Refresh the clue progress + clue text
                    await refreshGroupPartial();
                } else {
                    console.log("❌", data.message || "Incorrect code");
                    showAlert("❌ Incorrect code. Try another!", "error");
                }
            } catch (err) {
                console.error("Failed to validate scan:", err);
                showFeedback("Scan failed. Try again.", "error");
            }
        }

        async function refreshGroupPartial() {
            try {
                const res = await fetch("/api/game-partial");
                const data = await res.json();

                document.getElementById("clueProgress").textContent =
                    data.completed ? "COMPLETE" : `Clue: ${data.progress}`;
                document.getElementById("clue").textContent = data.clue;
            } catch (err) {
                console.error("Failed to refresh clue:", err);
            }
        }


        async function cleanupScanner() {
            try {
                await stopCamera();
                if (qrScanner) {
                    qrScanner.destroy();
                    qrScanner = null;
                }
            } catch (e) {
                console.warn("scanner cleanup failed:", e);
            }
        }

        async function doLogout() {
            await cleanupScanner();
            try {
                await fetch("/logout", { method: "POST" });
            } catch (e) {
                console.error("Logout request failed:", e);
            }
            location.href = "/login";
        }

        document.getElementById("confirmLogout")?.addEventListener("click", async () => {
            document.getElementById("logoutModal").close();
            await doLogout();
        });

        function showAlert(message, type) {
            const container = document.getElementById("alertContainer");
            const div = document.createElement("div");
            div.setAttribute("role", "alert");
            div.className = `alert alert-${type} alert-soft shadow`;
            div.innerHTML = `<span>${message}</span>`;
            container.appendChild(div);

            // Auto remove after 2s
            setTimeout(() => div.remove(), 2000);
        }
    </script>
</body>

</html>